<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> [구현] AprilTag Pose Estimation | Joel Lee </title> <meta name="author" content="Joel Lee"> <meta name="description" content="Robotics Research Master's Student "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joonhyung-lee.github.io//blog/2023/apriltag-pose-estimation/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?bf50d6d9dd867d3e0f3b0add94449649"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Joel Lee </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">miscellaneous </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/repositories/">repositories</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/teaching/">teaching</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/gallery/">gallery</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">[구현] AprilTag Pose Estimation</h1> <p class="post-meta"> October 18, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/apriltag"> <i class="fa-solid fa-hashtag fa-sm"></i> AprilTag</a>   <a href="/blog/tag/calibration"> <i class="fa-solid fa-hashtag fa-sm"></i> Calibration</a>   <a href="/blog/tag/pose-estimation"> <i class="fa-solid fa-hashtag fa-sm"></i> Pose Estimation</a>     ·   <a href="/blog/category/programming"> <i class="fa-solid fa-tag fa-sm"></i> programming</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="apriltag">AprilTag</h2> <p>하나의 RGB-D camera 만으로 realworld의 물체의 <code class="language-plaintext highlighter-rouge">pose(translational+rotational)</code>를 추정해내는 것은 어렵다. 이를 수행해주기 위해서는 detection, segmentation, calibration 등 많은 것을 필요로 한다.</p> <p>이러한 부가적인 요소에 대해 손쉽게 pose를 얻어낼 수 있는 방식 중 하나가 Tag를 사용하는 것이며, 대표적으로는 opencv의 <a href="https://docs.opencv.org/4.x/d5/dae/tutorial_aruco_detection.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">ArUco</code></a>, APRIL robotics의 <a href="https://april.eecs.umich.edu/software/apriltag" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">AprilTag</code></a> 가 있다.</p> <p>실제 현업의 Robotics domain에서는 <code class="language-plaintext highlighter-rouge">AprilTag</code>를 사용하고 있는 것으로 알고 있으며, 이번에 논문 작성을 위한 realworld 실험에서도 <code class="language-plaintext highlighter-rouge">AprilTag</code>의 사용이 필수적이었다.</p> <p>대표적으로 사용되는 여러 종류의 모듈이 있지만, 나는 간단하게 <code class="language-plaintext highlighter-rouge">apriltag</code> 모듈을 사용했다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pip3</span> <span class="n">install</span> <span class="n">apriltag</span>
</code></pre></div></div> <h3 id="get-rgbd-image-from-d435i">Get RGBD image from <code class="language-plaintext highlighter-rouge">D435i</code> </h3> <p>우선 카메라로부터 이미지를 받아와야 한다. 나는 <code class="language-plaintext highlighter-rouge">RealSense D435i</code> camera를 사용했으며, 이를 위해 <code class="language-plaintext highlighter-rouge">pyrealsense2</code> module를 활용했다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pip3</span> <span class="n">install</span> <span class="n">pyrealsense2</span>
</code></pre></div></div> <p>아래는 <code class="language-plaintext highlighter-rouge">pyrealsense2</code>를 통해 D435i 카메라로부터 이미지를 얻어오는 과정이다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pyrealsense2</span> <span class="k">as</span> <span class="n">rs</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="n">utils.util</span> <span class="kn">import</span> <span class="n">r2rpy</span><span class="p">,</span> <span class="n">rpy2r</span><span class="p">,</span> <span class="n">r2t</span><span class="p">,</span> <span class="n">t2r</span><span class="p">,</span> <span class="n">pr2t</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">pipeline</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">config</span><span class="p">()</span>
<span class="n">config</span><span class="p">.</span><span class="nf">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="nb">format</span><span class="p">.</span><span class="n">z16</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># Order: [H x W]
</span><span class="n">config</span><span class="p">.</span><span class="nf">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">color</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="nb">format</span><span class="p">.</span><span class="n">bgr8</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># Order: [H x W]
</span>
<span class="n">profile</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">stream_depth</span> <span class="o">=</span> <span class="n">profile</span><span class="p">.</span><span class="nf">get_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>

<span class="c1">### Camera Parameters
</span><span class="n">intrinsic_matrix_depth</span> <span class="o">=</span> <span class="n">stream_depth</span><span class="p">.</span><span class="nf">as_video_stream_profile</span><span class="p">().</span><span class="nf">get_intrinsics</span><span class="p">()</span>
<span class="n">intrinsic_matrix_rgb</span> <span class="o">=</span> <span class="n">profile</span><span class="p">.</span><span class="nf">get_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">color</span><span class="p">).</span><span class="nf">as_video_stream_profile</span><span class="p">().</span><span class="nf">get_intrinsics</span><span class="p">()</span>
<span class="n">cam_params_depth</span> <span class="o">=</span> <span class="p">[</span><span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppx</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppy</span><span class="p">]</span>
<span class="n">cam_params_rgb</span> <span class="o">=</span> <span class="p">[</span><span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppx</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppy</span><span class="p">]</span>
<span class="n">cam_matrix_depth</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppx</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppy</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">cam_matrix_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppx</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppy</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

<span class="n">spatial</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">spatial_filter</span><span class="p">()</span>
<span class="n">spatial</span><span class="p">.</span><span class="nf">set_option</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">option</span><span class="p">.</span><span class="n">holes_fill</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">hole_filling</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">hole_filling_filter</span><span class="p">()</span>

<span class="n">depth_sensor</span> <span class="o">=</span> <span class="n">profile</span><span class="p">.</span><span class="nf">get_device</span><span class="p">().</span><span class="nf">first_depth_sensor</span><span class="p">()</span>
<span class="n">depth_scale</span> <span class="o">=</span> <span class="n">depth_sensor</span><span class="p">.</span><span class="nf">get_depth_scale</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Depth Scale is: </span><span class="sh">"</span><span class="p">,</span> <span class="n">depth_scale</span><span class="p">)</span>

<span class="n">zero_padding</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">clipping_distance_in_meters</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># clip: 3 [meter]
</span><span class="n">clipping_distance</span> <span class="o">=</span> <span class="n">clipping_distance_in_meters</span> <span class="o">/</span> <span class="n">depth_scale</span>

<span class="n">align_to</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">color</span>
<span class="n">align</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">align</span><span class="p">(</span><span class="n">align_to</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="nf">wait_for_frames</span><span class="p">()</span>
        <span class="c1">#frames.get_depth_frame() # 640x480 depth image
</span>
        <span class="n">aligned_frames</span><span class="o">=</span> <span class="n">align</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="n">depth_frame</span> <span class="o">=</span> <span class="n">aligned_frames</span><span class="p">.</span><span class="nf">get_depth_frame</span><span class="p">()</span>
        <span class="n">color_frame</span> <span class="o">=</span> <span class="n">aligned_frames</span><span class="p">.</span><span class="nf">get_color_frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">depth_frame</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">color_frame</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Apply filter to fill the Holes in the depth image
</span>        <span class="n">filtered_depth</span> <span class="o">=</span> <span class="n">spatial</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">depth_frame</span><span class="p">)</span>

        <span class="n">rgb_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">asanyarray</span><span class="p">(</span><span class="n">color_frame</span><span class="p">.</span><span class="nf">get_data</span><span class="p">())</span>
        <span class="n">filled_depth</span> <span class="o">=</span> <span class="n">hole_filling</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">filtered_depth</span><span class="p">)</span>
        <span class="n">depth_image_filled</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">asanyarray</span><span class="p">(</span><span class="n">filled_depth</span><span class="p">.</span><span class="nf">get_data</span><span class="p">())</span>
        <span class="n">depth_clipped_filled</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">((</span><span class="n">depth_image_filled</span> <span class="o">&gt;</span> <span class="n">clipping_distance</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">depth_image_filled</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">zero_padding</span><span class="p">,</span> <span class="n">depth_image_filled</span><span class="p">)</span>

        <span class="n">img_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">rgb_img</span><span class="p">)</span>
        <span class="n">img_bgr</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">img_copy</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
        <span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">img_bgr</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">img_xyz</span> <span class="o">=</span> <span class="nf">meters2xyz</span><span class="p">(</span><span class="n">depth_clipped_filled</span><span class="p">,</span> <span class="n">camera_info</span><span class="o">=</span><span class="n">intrinsic_matrix_depth</span><span class="p">)</span>

        <span class="n">cv2</span><span class="p">.</span><span class="nf">namedWindow</span><span class="p">(</span><span class="sh">'</span><span class="s">D435i Example</span><span class="sh">'</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">WINDOW_AUTOSIZE</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">'</span><span class="s">D435i Example</span><span class="sh">'</span><span class="p">,</span> <span class="n">overlay</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nf">ord</span><span class="p">(</span><span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
            <span class="n">cv2</span><span class="p">.</span><span class="nf">destroyAllWindows</span><span class="p">()</span>
            <span class="k">break</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">pipeline</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
</code></pre></div></div> <p>위 코드를 수행하게 되면, 아래와 같이 RGB-D image를 얻을 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">rgb_img</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div style="text-align:center"> <img src="/assets/img/apriltag/realsense-rgbd.png" alt="Alignment Method Image" width="100%"> <p>Fig. 1: RGBD image</p> </div> <h3 id="detect-tag">Detect tag</h3> <p>위 과정을 통해 기본적으로 RGBD 이미지를 받아올 수 있게 되었다. 그 다음 과정으로는 <code class="language-plaintext highlighter-rouge">tag</code> detection이다. Pose estimation을 위해서는 <code class="language-plaintext highlighter-rouge">tag</code>부터 명확하게 검출할 수 있어야하며, 당연히 <code class="language-plaintext highlighter-rouge">tag</code>가 검출된 이후에 <code class="language-plaintext highlighter-rouge">pose</code>를 추정할 수 있다. 아래는 <code class="language-plaintext highlighter-rouge">tag detection</code> 코드이다. (검출된 tag 기준의 <code class="language-plaintext highlighter-rouge">bounding cude</code> 함수도 구현하였다.)</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">apriltag</span>

<span class="k">def</span> <span class="nf">_draw_cube</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">camera_params</span><span class="p">,</span> <span class="n">tag_size</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">z_sign</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
        Draw the cube of the tag.
    </span><span class="sh">"""</span>
    <span class="c1"># object points
</span>    <span class="n">opoints</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>          <span class="c1"># Lower points
</span>         <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
         <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">z_sign</span><span class="p">,</span>  <span class="c1"># Upper points
</span>         <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">z_sign</span><span class="p">,</span>
         <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">z_sign</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">z_sign</span><span class="p">,</span>
    <span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">tag_size</span>

    <span class="c1"># image points
</span>    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
        <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
        <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span>
    <span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">camera_params</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">fx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">rvec</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">Rodrigues</span><span class="p">(</span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">tvec</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">dcoeffs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>    
    <span class="n">ipoints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">projectPoints</span><span class="p">(</span><span class="n">opoints</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dcoeffs</span><span class="p">)</span>
    <span class="n">ipoints</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">ipoints</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ipoints</span> <span class="o">=</span> <span class="p">[</span><span class="nf">tuple</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">ipoints</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ipoints</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">meters2xyz</span><span class="p">(</span><span class="n">depth_img</span><span class="p">,</span><span class="n">camera_info</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
        Scaled depth image to pointcloud
    </span><span class="sh">"""</span>
    <span class="n">fx</span> <span class="o">=</span> <span class="n">camera_info</span><span class="p">.</span><span class="n">fx</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">camera_info</span><span class="p">.</span><span class="n">ppx</span>
    <span class="n">fy</span> <span class="o">=</span> <span class="n">camera_info</span><span class="p">.</span><span class="n">fx</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">camera_info</span><span class="p">.</span><span class="n">ppy</span>

    <span class="n">height</span> <span class="o">=</span> <span class="n">camera_info</span><span class="p">.</span><span class="n">height</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">camera_info</span><span class="p">.</span><span class="n">width</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">indices</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">).</span><span class="nf">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">z_e</span> <span class="o">=</span> <span class="n">depth_img</span>
    <span class="n">x_e</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[...,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cx</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_e</span> <span class="o">/</span> <span class="n">fx</span>
    <span class="n">y_e</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cy</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_e</span> <span class="o">/</span> <span class="n">fy</span>
    
    <span class="c1"># scale to meter unit.
</span>    <span class="n">xyz_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="o">-</span><span class="n">y_e</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span> <span class="o">-</span><span class="n">x_e</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">z_e</span><span class="o">*</span><span class="mf">0.001</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Shape: [H x W x 3]
</span>    <span class="k">return</span> <span class="n">xyz_img</span> <span class="c1"># [H x W x 3]
</span>
<span class="c1"># apriltag setting.
</span><span class="n">detector</span> <span class="o">=</span> <span class="n">apriltag</span><span class="p">.</span><span class="nc">Detector</span><span class="p">()</span>
<span class="n">tag_size</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="c1"># Tag size: Diameter
</span><span class="n">img_xyz_clipped_filled</span> <span class="o">=</span> <span class="nf">meters2xyz</span><span class="p">(</span><span class="n">depth_clipped_filled</span><span class="p">,</span> <span class="n">camera_info</span><span class="o">=</span><span class="n">intrinsic_matrix_depth</span><span class="p">)</span>

<span class="n">img_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="nf">deepcopy</span><span class="p">(</span><span class="n">color_image</span><span class="p">)</span>
<span class="n">img_bgr</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">img_copy</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
<span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">img_bgr</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">img_xyz</span> <span class="o">=</span> <span class="nf">meters2xyz</span><span class="p">(</span><span class="n">depth_clipped_filled</span><span class="p">,</span> <span class="n">camera_info</span><span class="o">=</span><span class="n">intrinsic_matrix_depth</span><span class="p">)</span>

<span class="n">results</span><span class="p">,</span> <span class="n">dimg</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">detect</span><span class="p">(</span><span class="n">img_gray</span><span class="p">,</span> <span class="n">return_image</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">img_copy</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">overlay</span> <span class="o">=</span> <span class="n">img_copy</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dimg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">overlay</span> <span class="o">=</span> <span class="n">img_copy</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dimg</span> <span class="o">//</span> <span class="mi">2</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">pose</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">detection_pose</span><span class="p">(</span><span class="n">detection</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">camera_params</span><span class="o">=</span><span class="n">cam_params_rgb</span><span class="p">,</span> <span class="n">tag_size</span><span class="o">=</span><span class="n">tag_size</span><span class="p">)</span>    <span class="c1"># should check tag_size
</span>    <span class="n">center_uv</span> <span class="o">=</span> <span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nf">_draw_cube</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span>
                <span class="n">cam_params_rgb</span><span class="p">,</span>
                <span class="n">tag_size</span><span class="p">,</span>
                <span class="n">pose</span><span class="p">)</span>
<span class="n">cv2</span><span class="p">.</span><span class="nf">namedWindow</span><span class="p">(</span><span class="sh">'</span><span class="s">Tag Detection Example</span><span class="sh">'</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">WINDOW_AUTOSIZE</span><span class="p">)</span>
<span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">'</span><span class="s">Tag Detection Example</span><span class="sh">'</span><span class="p">,</span> <span class="n">overlay</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nf">ord</span><span class="p">(</span><span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
    <span class="n">cv2</span><span class="p">.</span><span class="nf">destroyAllWindows</span><span class="p">()</span>
    <span class="k">break</span>
</code></pre></div></div> <p>위 코드의 <code class="language-plaintext highlighter-rouge">results, dimg = detector.detect(img_gray, return_image=True)</code> 를 통해 입력 이미지 <code class="language-plaintext highlighter-rouge">img_gray</code>에 있는 <code class="language-plaintext highlighter-rouge">tag</code>를 검출하게 된다. 우선 gray scale의 이미지를 사용하는 이유는 다음과 같다.</p> <ul> <li>color 채널이 제거되며, 패턴을 더욱 뚜렷하게 표현할 수 있다.</li> <li>일반적으로 패턴을 검출할 때에는 인접 픽셀 값의 차이를 사용하는데, gray 채널은 픽셀 당 하나의 값을 가지므로 연산이 간단하고 빨라진다.</li> </ul> <div style="text-align:center"> <img src="/assets/img/apriltag/apriltag_algorithm.png" alt="Alignment Method Image" width="100%"> <p>Fig. 2: Overall algorithm of AprilTag</p> </div> <p>검출된 <code class="language-plaintext highlighter-rouge">tag</code>에 대한 정보는 dictionary 형태로 얻어지며, 각 내용은 아래와 같다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Detection</span><span class="p">(</span><span class="n">tag_family</span><span class="o">=</span><span class="sa">b</span><span class="sh">'</span><span class="s">tag36h11</span><span class="sh">'</span><span class="p">,</span> 
          <span class="n">tag_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
          <span class="n">hamming</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
          <span class="n">goodness</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> 
          <span class="n">decision_margin</span><span class="o">=</span><span class="mf">105.59999084472656</span><span class="p">,</span> 
          <span class="n">homography</span><span class="o">=</span><span class="nf">array</span><span class="p">([[</span> <span class="o">-</span><span class="mf">0.81</span><span class="p">,</span>   <span class="mf">0.36</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.45</span><span class="p">],</span>
                            <span class="p">[</span>  <span class="mf">0.</span>  <span class="p">,</span>  <span class="o">-</span><span class="mf">0.32</span><span class="p">,</span>  <span class="o">-</span><span class="mf">8.8</span> <span class="p">],</span>
                            <span class="p">[</span>  <span class="mf">0.</span>  <span class="p">,</span>   <span class="mf">0.</span>  <span class="p">,</span>  <span class="o">-</span><span class="mf">0.02</span><span class="p">]]),</span>
          <span class="n">center</span><span class="o">=</span><span class="nf">array</span><span class="p">([</span><span class="mf">582.71</span><span class="p">,</span> <span class="mf">448.03</span><span class="p">]),</span> 
          <span class="n">corners</span><span class="o">=</span><span class="nf">array</span><span class="p">([[</span><span class="mf">543.41</span><span class="p">,</span> <span class="mf">418.91</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">623.08</span><span class="p">,</span> <span class="mf">418.91</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">624.49</span><span class="p">,</span> <span class="mf">478.99</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">539.82</span><span class="p">,</span> <span class="mf">478.99</span><span class="p">]]))</span>
</code></pre></div></div> <p>각각에 해당하는 용어 설명은 아래와 같다. &lt;!DOCTYPE html&gt;</p> <style>table{border-collapse:collapse;width:100%}th,td{border:1px solid black;padding:8px;text-align:left}th{background-color:#f2f2f2}</style> <table> <tr> <th>Attribute</th> <th>Explanation</th> </tr> <tr> <td>tag_family</td> <td>The family of the tag.</td> </tr> <tr> <td>tag_id</td> <td>The decoded ID of the tag.</td> </tr> <tr> <td>hamming</td> <td>How many error bits were corrected? Note: accepting large numbers of corrected errors leads to greatly increased false positive rates. NOTE: As of this implementation, the detector cannot detect tags with a Hamming distance greater than 3.</td> </tr> <tr> <td>decision_margin</td> <td>A measure of the quality of the binary decoding process: the average difference between the intensity of a data bit versus the decision threshold. Higher numbers roughly indicate better decodes. This is a reasonable measure of detection accuracy only for very small tags -- not effective for larger tags (where we could have sampled anywhere within a bit cell and still gotten a good detection.)</td> </tr> <tr> <td>homography</td> <td>The 3x3 homography matrix describing the projection from an "ideal" tag (with corners at (-1,1), (1,1), (1,-1), and (-1,-1)) to pixels in the image.</td> </tr> <tr> <td>center</td> <td>The center of the detection in image pixel coordinates.</td> </tr> <tr> <td>corners</td> <td>The corners of the tag in image pixel coordinates. These always wrap counter-clockwise around the tag.</td> </tr> </table> <p>아래는 tag detection 결과이며, 직관적인 이해를 위해 <code class="language-plaintext highlighter-rouge">tag</code>를 둘러싸는 <code class="language-plaintext highlighter-rouge">cube</code>도 그려보았다.</p> <div style="text-align: center;"> <video src="/assets/video/apriltag/apriltag-real.mp4" width="100%" controls=""></video> </div> <h3 id="pose-estimation">Pose Estimation</h3> <p>마지막으로, 검출된 <code class="language-plaintext highlighter-rouge">tag</code> 정보를 기반으로 <code class="language-plaintext highlighter-rouge">tag</code>의 <code class="language-plaintext highlighter-rouge">pose</code>도 손쉽게 알아낼 수 있다. 해당 함수는 <code class="language-plaintext highlighter-rouge">detector.detection_pose(detection=r, camera_params=cam_params_rgb, tag_size=tag_size)</code> 이며, 이에 해당하는 4x4 <code class="language-plaintext highlighter-rouge">pose</code> matrix와 오차값 \(\mathrm{e_{1}},~\mathrm{e_{2}}\) 를 내어준다.</p> <p>apriltag 모듈로 들어가, 해당 함수를 조금 더 자세히 분석해보면 어떻게 tag pose를 얻어오는지 이해할 수 있다. 해당 함수의 코드만 가져왔으며, <code class="language-plaintext highlighter-rouge">class Detector</code>의 멤버함수이다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">detection_pose</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">detection</span><span class="p">,</span> <span class="n">camera_params</span><span class="p">,</span> <span class="n">tag_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">z_sign</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">c_double</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">camera_params</span> <span class="p">]</span>
    
    <span class="n">H</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">libc</span><span class="p">.</span><span class="nf">matd_create</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="nf">_matd_get_array</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">detection</span><span class="p">.</span><span class="n">homography</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="n">detection</span><span class="p">.</span><span class="n">corners</span><span class="p">.</span><span class="nf">flatten</span><span class="p">().</span><span class="nf">astype</span><span class="p">(</span><span class="n">numpy</span><span class="p">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">dptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">c_double</span><span class="p">)</span>

    <span class="n">corners</span> <span class="o">=</span> <span class="n">corners</span><span class="p">.</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">data_as</span><span class="p">(</span><span class="n">dptr</span><span class="p">)</span>

    <span class="n">init_error</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">c_double</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">final_error</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">c_double</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">Mptr</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">libc</span><span class="p">.</span><span class="nf">pose_from_homography</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span>
                                          <span class="n">ctypes</span><span class="p">.</span><span class="nf">c_double</span><span class="p">(</span><span class="n">tag_size</span><span class="p">),</span>
                                          <span class="n">ctypes</span><span class="p">.</span><span class="nf">c_double</span><span class="p">(</span><span class="n">z_sign</span><span class="p">),</span>
                                          <span class="n">corners</span><span class="p">,</span>
                                          <span class="nf">dptr</span><span class="p">(</span><span class="n">init_error</span><span class="p">),</span>
                                          <span class="nf">dptr</span><span class="p">(</span><span class="n">final_error</span><span class="p">))</span>

    <span class="n">M</span> <span class="o">=</span> <span class="nf">_matd_get_array</span><span class="p">(</span><span class="n">Mptr</span><span class="p">).</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">libc</span><span class="p">.</span><span class="nf">matd_destroy</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">libc</span><span class="p">.</span><span class="nf">matd_destroy</span><span class="p">(</span><span class="n">Mptr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">init_error</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">final_error</span><span class="p">.</span><span class="n">value</span>
</code></pre></div></div> <p>코드를 보면 알 수 있듯이, camera의 <code class="language-plaintext highlighter-rouge">intrinsic parameter</code>와 검출된 <code class="language-plaintext highlighter-rouge">tag</code>의 <code class="language-plaintext highlighter-rouge">homography matrix</code> 정보 만으로 pose를 추정해낼 수 있다. <code class="language-plaintext highlighter-rouge">homography matrix</code>를 구하는 과정과 정의는 다음과 같다.</p> <blockquote> <p><strong>How to get Homography matrix?</strong></p> <ul> <li> <a href="https://april.eecs.umich.edu/media/pdfs/olson2011tags.pdf" rel="external nofollow noopener" target="_blank">논문</a>에서 밝히길, <code class="language-plaintext highlighter-rouge">Homography matrix</code>는 <code class="language-plaintext highlighter-rouge">Direct Linear Transform (DLT)</code> 방법론으로 구한다고 한다.</li> <li> <code class="language-plaintext highlighter-rouge">DLT</code>란 Four point correspondences \(x_{i}\), \(x_{i}'\) ​ 가 주어질 때에. \(H x_{i} = x_{i}'\) 이면, \(x_{i}' \times H x_{i} = 0\) 이 성립한다는 것이다.</li> </ul> <p><strong>Definition of Homography matrix</strong> Briefly, the planar homography relates the transformation between two planes (up to a scale factor):</p> \[\begin{equation*} s \begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} = \mathbf{H} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix} = \begin{bmatrix} h_{11} &amp; h_{12} &amp; h_{13} \\ h_{21} &amp; h_{22} &amp; h_{23} \\ h_{31} &amp; h_{32} &amp; h_{33} \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix} \end{equation*}\] <p>The homography matrix is a 3x3 matrix but with 8 DoF (degrees of freedom) as it is estimated up to a scale. It is generally normalized (see also 1) with \(h_{33}=1\) or \(h_{11}^2 + h_{12}^2 + h_{13}^2 + h_{21}^2 + h_{22}^2 + h_{23}^2 + h_{31}^2 + h_{32}^2 + h_{33}^2 = 1\)</p> </blockquote> <div style="text-align:center"> <img src="/assets/img/apriltag/homography-matrix.png" alt="Alignment Method Image" width="50%"> <p>Fig. 3: a planar surface and the image plane</p> </div> <p>즉, <code class="language-plaintext highlighter-rouge">planar surface</code>와 <code class="language-plaintext highlighter-rouge">image plane</code>을 matching 해주는 matrix라고 생각하면 된다. 내가 사용한 <code class="language-plaintext highlighter-rouge">RealSense D435i</code> 카메라는 양안 렌즈이며, <code class="language-plaintext highlighter-rouge">rgb_camera</code>와 <code class="language-plaintext highlighter-rouge">depth_camera</code>의 <code class="language-plaintext highlighter-rouge">intrinsic parameter</code>가 개별적으로 설정되어 있다. 이는 <code class="language-plaintext highlighter-rouge">pyrealsense2</code> module로 손쉽게 구할 수 있으며, 이에 해당하는 코드는 아래와 같다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pyrealsense2</span> <span class="k">as</span> <span class="n">rs</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="n">utils.util</span> <span class="kn">import</span> <span class="n">r2rpy</span><span class="p">,</span> <span class="n">rpy2r</span><span class="p">,</span> <span class="n">r2t</span><span class="p">,</span> <span class="n">t2r</span><span class="p">,</span> <span class="n">pr2t</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">pipeline</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">rs</span><span class="p">.</span><span class="nf">config</span><span class="p">()</span>
<span class="n">config</span><span class="p">.</span><span class="nf">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="nb">format</span><span class="p">.</span><span class="n">z16</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># Order: [H x W]
</span><span class="n">config</span><span class="p">.</span><span class="nf">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">color</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="nb">format</span><span class="p">.</span><span class="n">bgr8</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># Order: [H x W]
</span>
<span class="n">profile</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">stream_depth</span> <span class="o">=</span> <span class="n">profile</span><span class="p">.</span><span class="nf">get_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span>

<span class="c1">### Camera Parameters
</span><span class="n">intrinsic_matrix_depth</span> <span class="o">=</span> <span class="n">stream_depth</span><span class="p">.</span><span class="nf">as_video_stream_profile</span><span class="p">().</span><span class="nf">get_intrinsics</span><span class="p">()</span>
<span class="n">intrinsic_matrix_rgb</span> <span class="o">=</span> <span class="n">profile</span><span class="p">.</span><span class="nf">get_stream</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">color</span><span class="p">).</span><span class="nf">as_video_stream_profile</span><span class="p">().</span><span class="nf">get_intrinsics</span><span class="p">()</span>

<span class="n">cam_params_depth</span> <span class="o">=</span> <span class="p">[</span><span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppx</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppy</span><span class="p">]</span>
<span class="n">cam_params_rgb</span> <span class="o">=</span> <span class="p">[</span><span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppx</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppy</span><span class="p">]</span>
<span class="n">cam_matrix_depth</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppx</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_depth</span><span class="p">.</span><span class="n">ppy</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">cam_matrix_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppx</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">intrinsic_matrix_rgb</span><span class="p">.</span><span class="n">ppy</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">pyrealsense</code>를 사용하지 않고, <code class="language-plaintext highlighter-rouge">ros topic</code>로도 손쉽게 정보를 얻어올 수 있다. 그러기 위해서는 ROS로 D435i와 연결해주어야 하며, 해당하는 터미널 라인은 아래와 같다.</p> <div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ros2 run realsense2_camera realsense2_camera_node
</span></code></pre></div></div> <p>잘 연결 되었다면, 아래의 터미널 라인을 통해 각각에 해당하는 camera parameter를 얻어올 수 있다. (자세한 정보는 <a href="https://github.com/IntelRealSense/realsense-ros/blob/ros2-development/README.md" rel="external nofollow noopener" target="_blank">공식 레포</a>에서 확인할 수 있다.)</p> <div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ros2 topic echo /color/camera_info
ros2 topic echo /depth/camera_info
</span></code></pre></div></div> <p>각각의 토픽에서 어떠한 내용을 갖고있는지는 <a href="http://docs.ros.org/en/api/sensor_msgs/html/msg/CameraInfo.html" rel="external nofollow noopener" target="_blank">ROS realsense_camera wiki</a>에서 자세한 정보를 알 수 있다.</p> <table> <thead> <tr> <th> <code class="language-plaintext highlighter-rouge">/color/camera_info</code> &amp; <code class="language-plaintext highlighter-rouge">/depth/camera_info</code> </th> <th><strong>Explanation</strong></th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">std_msgs/Header header</code></td> <td>Time of image acquisition, camera coordinate frame ID</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">uint32 height</code> &amp; <code class="language-plaintext highlighter-rouge">uint32 width</code> </td> <td>The image dimensions with which the camera was calibrated. Normally this will be the full camera resolution in pixels.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">string distortion_model</code></td> <td>The distortion model used. Supported models are listed in sensor_msgs/distortion_models.h. For most cameras, “plumb_bob” - a simple model of radial and tangential distortion - is sufficient.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">float64[] D</code></td> <td>The distortion parameters, size depending on the distortion model. For “plumb_bob”, the 5 parameters are: <strong>(k1, k2, t1, t2, k3)</strong>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">float64[9] K</code></td> <td># Intrinsic camera matrix for the raw (distorted) images. Projects 3D points in the camera coordinate frame to 2D pixel coordinates using the focal lengths <strong>(fx, fy)</strong> and principal point <strong>(cx, cy)</strong>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">float64[9] R</code></td> <td>Rectification matrix (stereo cameras only). A rotation matrix aligning the camera coordinate system to the ideal stereo image plane so that epipolar lines in both stereo images are parallel.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">float64[12] P</code></td> <td>Projection/camera matrix. By convention, this matrix specifies the intrinsic (camera) matrix of the processed (rectified) image. That is, the left 3x3 portion is the normal camera intrinsic matrix for the rectified image. It projects 3D points in the camera coordinate frame to 2D pixel coordinates using the focal lengths (fx’, fy’) and principal point (cx’, cy’) - these may differ from the values in K.</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">uint32 binning_x</code> &amp; <code class="language-plaintext highlighter-rouge">uint32 binning_y</code> </td> <td>Binning refers here to any camera setting which combines rectangular neighborhoods of pixels into larger “super-pixels.” It reduces the resolution of the output image to (width / binning_x) x (height / binning_y). The default values binning_x = binning_y = 0 is considered the same as binning_x = binning_y = 1 (no subsampling).</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">sensor_msgs/RegionOfInterest roi</code></td> <td>Region of interest (subwindow of full camera resolution), given in full resolution (unbinned) image coordinates. A particular ROI always denotes the same window of pixels on the camera sensor, regardless of binning settings. The default setting of roi (all values 0) is considered the same as full resolution (roi.width = width, roi.height = height).</td> </tr> </tbody> </table> <p>당연하게도, 여기서 사용되는 <code class="language-plaintext highlighter-rouge">intrinsic parameter</code>는 <code class="language-plaintext highlighter-rouge">rgb_camera</code>의 정보를 사용해야만 한다. (입력으로 넣어주었던 이미지가 <code class="language-plaintext highlighter-rouge">rgb_camera</code>에서 얻어온 것이므로.)</p> <p><code class="language-plaintext highlighter-rouge">pose_from_homography</code> 함수에 대한 c++ code는 <a href="https://docs.opencv.org/4.x/d0/d92/samples_2cpp_2tutorial_code_2features2D_2Homography_2pose_from_homography_8cpp-example.html" rel="external nofollow noopener" target="_blank">OpenCV 공식 페이지</a>에서 확인할 수 있다.</p> <p>Homography matrix로 pose estimation을 하는 과정은 <a href="https://www.robots.ox.ac.uk/~vgg/hzbook/hzbook2/HZepipolar.pdf" rel="external nofollow noopener" target="_blank">Multiple View Geometry in Computer Vision Second Edition</a>의 Sec. 9.6.2에서 확인할 수 있다.</p> <p>위에서 구한 <code class="language-plaintext highlighter-rouge">Homography matrix</code>를 통해 상대적인 <code class="language-plaintext highlighter-rouge">pose [R|t]</code>를 구하기 위하여 <code class="language-plaintext highlighter-rouge">Singular Value Decomposition(SVD)</code>을 활용합니다. <code class="language-plaintext highlighter-rouge">SVD</code>는 행렬을 대학화하는 방법 중 하나이다.</p> <ol> <li> <strong>Homogeneous Coordinates (동차 좌표계)</strong>: <ul> <li>먼저, 카메라와 3D point 간의 관계를 표현하기 위해 <code class="language-plaintext highlighter-rouge">동차 좌표계</code>를 사용한다. 3D point는 \((X, Y, Z, 1)^T\)와 같이 표현되며, 2D image point는 \((x, y, 1)^T\)로 표현된다.</li> </ul> </li> <li> <strong>Homography Equation</strong>: <ul> <li> <p>Homography 행렬 H는 다음과 같은 관계를 나타낸다:</p> \[\begin{equation*} \begin{bmatrix} s \cdot x' \\ s \cdot y' \\ s \end{bmatrix} = s \begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} = \mathbf{H} \begin{bmatrix} X \\ Y \\ Z \\ 1 \end{bmatrix} \end{equation*}\] </li> <li> <p>여기서 \((x', y')\)는 image plane 상의 2D point이고 \((X, Y, Z)\)는 3D 공간 상의 3D point이다. \(s\)는 스케일 요소로, 일반적으로 1로 설정된다.</p> </li> </ul> </li> <li> <strong>Homography Decomposition</strong>: <ul> <li> <code class="language-plaintext highlighter-rouge">Homography matrix</code> \(\mathrm{H}\)의 분해는 rotational matrix \(\mathrm{R}\)과 translational vector \(\text{tvec}\)으로 이루어진다.</li> <li>Decomposition 과정은 아래와 같이 수행된다. \(\begin{equation*} \mathbf{H} = \mathbf{K} \left[ \begin{array}{ccc|c} r_{11} &amp; r_{12} &amp; r_{13} &amp; t_x \\ r_{21} &amp; r_{22} &amp; r_{23} &amp; t_y \\ r_{31} &amp; r_{32} &amp; r_{33} &amp; t_z \\ \end{array} \right] \end{equation*}\) 여기서 \(\mathbf{K}\)는 camera intrinsic matrix이고, \(r_{ij}\)는 회전 행렬 \(\mathrm{R}\)의 각 요소이다.</li> </ul> </li> <li> <strong>Polar Decomposition</strong>: <ul> <li>회전 행렬 \(\mathrm{R}\)에 대해 <code class="language-plaintext highlighter-rouge">polar decomposition</code>을 사용하여 <code class="language-plaintext highlighter-rouge">orthonormal matrix</code>로 분해한다. <code class="language-plaintext highlighter-rouge">polar decomposition</code>는 \(\mathrm{R}\)을 <code class="language-plaintext highlighter-rouge">SVD</code> 과정으로 \(\mathrm{R} = \mathrm{U} \cdot \mathrm{V^T}\)로 분해한다. <ul> <li>특이값 분해에서 얻은 \(\mathrm{U}\)와 \(\mathrm{V}\)를 사용하여 보정된 \(\mathrm{R}\)을 계산하며, 보정된 회전 행렬 \(\mathrm{R'}\)은 다음과 같이 수행된다. \(\begin{equation*} \mathrm{R'} = \frac{1}{\text{det}(\mathrm{V^T})} \cdot \mathrm{U} \end{equation*}\)</li> </ul> </li> </ul> </li> <li> <strong>Get <code class="language-plaintext highlighter-rouge">rvec</code></strong>: <ul> <li>보정된 회전 행렬 \(\mathrm{R'}\)을 사용하여 <code class="language-plaintext highlighter-rouge">Rodrigues</code> 변환을 사용하여 회전 벡터 <code class="language-plaintext highlighter-rouge">rvec</code>으로 변환한다.</li> </ul> </li> </ol> <p>이렇게 긴 과정을 거쳐, <code class="language-plaintext highlighter-rouge">AprilTag</code>의 pose가 검출된다. 검출된 tag의 pose는 camera coordinate 기준이며, 이는 각자가 설정한 base(=world) coordinate로 transformation 과정을 마지막으로 수행해주면, tag의 pose를 얻어낼 수 있게 된다.</p> <div style="text-align: center;"> <video src="/assets/video/apriltag/apriltag-real-track.mp4" width="100%" controls=""></video> </div> <p>검출된 <code class="language-plaintext highlighter-rouge">Tag</code>의 <code class="language-plaintext highlighter-rouge">center point</code>를 base(=world) coordinate 기준으로 계산된 \((x,y,z)_{\text{world}}\) 를 실시간으로 우측 상단에 배치하였다. 나는 MuJoCo의 coordination을 world coordinate로 삼았으며, 이는 아래와 같다.</p> <div style="text-align:center"> <img src="/assets/img/apriltag/coordination.png" alt="Alignment Method Image" width="75%"> <p>Fig. 4: Coordination</p> </div> <ul> <li>Coordination of MuJoCo Engine <ul> <li>\(\mathrm{X}\): Out of the camera</li> <li>\(\mathrm{Y}\): Left</li> <li>\(\mathrm{Z}\) : Up</li> </ul> </li> <li>Coodination of AprilTag <ul> <li>\(\mathrm{X}\): Right</li> <li>\(\mathrm{Y}\): Down</li> <li>\(\mathrm{Z}\) : Into the Tag <ul> <li>In the <a href="https://github.com/AprilRobotics/apriltag#coordinate-system" rel="external nofollow noopener" target="_blank">official repository</a>, <blockquote> <p>The coordinate system has the origin at the camera center. The z-axis points from the camera center out the camera lens. The x-axis is to the right in the image taken by the camera, and y is down. The tag’s coordinate frame is centered at the center of the tag, with x-axis to the right, y-axis down, and z-axis into the tag.</p> </blockquote> </li> </ul> </li> </ul> </li> </ul> <p>잘 안 보이겠지만, 줄자로 길이를 가늠해보았을 때 실제 scale에 맞게 Translational 정보를 잘 추정하는 것을 알 수 있다.</p> <div style="text-align:center"> <img src="/assets/img/apriltag/table-spec.png" alt="Alignment Method Image" width="50%"> <p>Fig. 5: Table configuration.</p> </div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/mdn/">[study] Mixture Density Network</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/vq/">[study] Vector Quantization</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/prs/">[paper-review] Poisson Reconstruction</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/dream2real/">[paper-review] Dream2Real: Zero-Shot 3D Object Rearrangement with Vision-Language Models</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/cpl/">[paper-review] Contrastive Prefence Learning: Learning from Human Feedback without RL</a> </li> <div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"joonhyung-lee/joonhyung-lee.github.io","data-repo-id":"","data-category":"Comments","data-category-id":"","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Joel Lee. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?7254ae07fe9cc5f3a10843e1c0817c9c" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>